<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">
<head>
  <title th:text="'Tarea: ' + ${task.title}">Detalle Tarea</title>
</head>
<body>
<section layout:fragment="content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0" th:text="${task.title}">Título Tarea</h1>
    <!-- Action Buttons (Mainly for Manager) -->
    <div class="btn-toolbar">
      <div class="btn-group btn-group-sm me-2">
        <!-- Back button depends on role -->
        <a sec:authorize="hasAuthority('GESTOR')" th:href="@{/projects/{id}(id=${task.project.id})}" class="btn btn-outline-secondary" title="Volver al Proyecto"><i class="bi bi-arrow-left"></i> Volver al Proyecto</a>
        <a sec:authorize="hasAuthority('COLABORADOR')" th:href="@{/collaborator/tasks}" class="btn btn-outline-secondary" title="Volver a Mis Tareas"><i class="bi bi-arrow-left"></i> Volver a Tareas</a>
      </div>
      <!-- Edit/Delete Buttons (Manager, if project not closed) -->
      <div class="btn-group btn-group-sm" sec:authorize="hasAuthority('GESTOR')" th:if="${!task.project.closed}">
        <a th:href="@{/tasks/{taskId}/edit(taskId=${task.id})}" class="btn btn-warning" title="Editar Tarea"><i class="bi bi-pencil-fill"></i> Editar</a>
        <form th:action="@{/tasks/{taskId}/delete(taskId=${task.id})}" method="post" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar esta tarea?');">
          <button type="submit" class="btn btn-danger" title="Eliminar Tarea"><i class="bi bi-trash-fill"></i> Eliminar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Task Details Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Detalles de la Tarea</h5>
      <div class="row">
        <div class="col-md-6 mb-2">
          <p class="mb-1"><strong><i class="bi bi-folder2-open me-2"></i>Proyecto:</strong> <a th:href="@{/projects/{id}(id=${task.project.id})}" th:text="${task.project.title}" class="text-decoration-none">Nombre Proyecto</a></p>
        </div>
        <div class="col-md-6 mb-2">
          <p class="mb-1"><strong><i class="bi bi-person-check me-2"></i>Asignada a:</strong> <span th:text="${task.assignedUser?.nombre} + ' ' + ${task.assignedUser?.apellidos ?: ''}"></span></p>
        </div>
        <div class="col-md-6 mb-2">
          <p class="mb-1"><strong><i class="bi bi-calendar-event me-2"></i>Vencimiento:</strong> <span th:text="${task.dueDate != null ? #temporals.format(task.dueDate, 'dd MMMM yyyy') : '-'}"></span></p>
        </div>
        <div class="col-md-6 mb-2">
          <p class="mb-1"><strong><i class="bi bi-flag me-2"></i>Estado:</strong>
            <span th:switch="${task.status.name()}">
                    <span th:case="'PENDIENTE'" class="badge bg-warning text-dark" th:text="${task.status.displayName}"></span>
                    <span th:case="'EN_PROGRESO'" class="badge bg-primary" th:text="${task.status.displayName}"></span>
                    <span th:case="'COMPLETADA'" class="badge bg-success" th:text="${task.status.displayName}"></span>
                    <span th:case="*" class="badge bg-secondary" th:text="${task.status}"></span>
                 </span>
          </p>
        </div>
        <div class="col-md-6 mb-2">
          <p class="mb-1"><strong><i class="bi bi-calendar-plus me-2"></i>Creada:</strong> <span class="text-muted small" th:text="${#temporals.format(task.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
        </div>
      </div>
      <p th:if="${task.description != null && !task.description.isEmpty()}" class="mt-3 mb-0 border-top pt-3">
        <strong><i class="bi bi-text-left me-2"></i>Descripción:</strong><br>
        <span class="text-muted" th:text="${task.description}"></span>
      </p>

      <!-- Collaborator Actions: Mark Accepted/Complete -->
      <div class="mt-3 pt-3 border-top"
           sec:authorize="hasAuthority('COLABORADOR')"
           th:if="${task.assignedUser?.email == #authentication.name and !task.project.closed}">

        <form th:if="${task.status.name() == 'PENDIENTE'}"
              th:action="@{/tasks/{taskId}/accepted(taskId=${task.id})}" method="post" class="d-inline-block me-2">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check2-circle me-1"></i> Aceptar Tarea (Marcar En Progreso)
          </button>
        </form>
        <form th:if="${task.status.name() == 'EN_PROGRESO'}"
              th:action="@{/tasks/{taskId}/complete(taskId=${task.id})}" method="post" class="d-inline-block">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i> Marcar como Completada
          </button>
        </form>
      </div>

    </div>
  </div>

  <!-- Comments Section -->
  <div class="card shadow-sm">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i> Comentarios</h5>
    </div>
    <div class="card-body">
      <div class="comments-list mb-4">
        <div th:if="${#lists.isEmpty(comments)}" class="alert alert-light text-center fst-italic border-0">
          No hay comentarios todavía. ¡Sé el primero en añadir uno!
        </div>

        <!-- Comment Loop -->
        <div th:each="comment : ${comments}" class="d-flex mb-3">
          <img th:src="${comment.author.fotoUrl ?: '/images/default-avatar.png'}" alt="Avatar"
               class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
          <div class="flex-grow-1">
            <div class="bg-light p-2 px-3 rounded" style="border-radius: 15px;">
              <p class="mb-1" th:text="${comment.content}"></p>
            </div>
            <small class="text-muted ms-1">
              Por <strong th:text="${comment.author.nombre} + ' ' + ${comment.author.apellidos}"></strong>
              el <span th:text="${#temporals.format(comment.createdAt, 'dd/MM/yy HH:mm')}"></span>
            </small>
          </div>
        </div>
      </div>

      <!-- Add Comment Form (if allowed and project not closed) -->
      <div th:if="${task.assignedUser?.email == #authentication.name and !task.project.closed}">
        <hr class="my-4">
        <h6 class="mb-3">Añadir Comentario</h6>
        <!-- Comment error handled globally -->
        <form th:action="@{/tasks/{taskId}/comment(taskId=${task.id})}" th:object="${newComment}" method="post">
          <div class="mb-3">
            <label for="content" class="form-label visually-hidden">Nuevo Comentario:</label>
            <textarea id="content" th:field="*{content}" class="form-control" rows="3" placeholder="Escribe tu comentario aquí..." required></textarea>
            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-send me-1"></i> Enviar Comentario
          </button>
        </form>
      </div>
      <!-- Message if project is closed -->
      <div th:if="${task.project.closed}" class="alert alert-warning mt-3 text-center fst-italic p-2">
        <i class="bi bi-lock-fill me-1"></i> No se pueden añadir comentarios porque el proyecto está cerrado.
      </div>
    </div>
  </div>

</section>
</body>
</html>
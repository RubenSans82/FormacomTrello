<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">
<head>
    <title th:text="'Proyecto: ' + ${project.title}">Detalle Proyecto</title>
</head>
<body>
<section layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0 me-2 d-inline-block" th:text="${project.title}">Título Proyecto</h1>
            <span th:text="${project.closed ? 'Cerrado' : 'Activo'}"
                  th:classappend="${project.closed ? 'badge bg-secondary fs-6 align-middle' : 'badge bg-success fs-6 align-middle'}">
                   Estado
             </span>
        </div>
        <div>
            <!-- Back button for collaborator -->
            <a th:href="@{/projects/collaborator/list}" class="btn btn-outline-secondary btn-sm" title="Volver a Mis Proyectos">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <!-- Manager specific actions (display none for collaborator but keep for consistency if manager uses same template?) -->
            <a sec:authorize="hasAuthority('GESTOR')" th:if="${!project.closed}" th:href="@{/projects/{id}/edit(id=${project.id})}" class="btn btn-warning btn-sm ms-2" title="Editar Proyecto"><i class="bi bi-pencil"></i> Editar</a>
            <form sec:authorize="hasAuthority('GESTOR')" th:action="@{/projects/{id}/close(id=${project.id})}" method="post" class="d-inline ms-2" th:if="${!project.closed}" onsubmit="return confirm('¿Estás seguro de cerrar este proyecto?');">
                <button type="submit" class="btn btn-danger btn-sm" title="Cerrar Proyecto"><i class="bi bi-lock"></i> Cerrar</button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Detalles del Proyecto</h5>
            <p th:if="${project.description}" class="text-muted mb-3" th:text="${project.description}">Descripción del proyecto.</p>
            <p class="mb-1"><strong><i class="bi bi-person-badge me-2"></i>Propietario (Gestor):</strong> <span th:text="${project.owner.nombre} + ' ' + ${project.owner.apellidos}"></span></p>
            <p class="mb-0"><strong><i class="bi bi-calendar-plus me-2"></i>Creado:</strong> <span th:text="${#temporals.format(project.createdAt, 'dd MMMM yyyy, HH:mm')}"></span></p>
        </div>
    </div>

    <!-- Sección de Colaboradores -->
    <div class="mb-4">
        <h3 class="h5 mb-3"><i class="bi bi-people me-2"></i> Colaboradores</h3>
        <div th:if="${!#lists.isEmpty(project.collaborators)}" class="list-group shadow-sm">
            <div class="list-group-item d-flex justify-content-between align-items-center" th:each="collab : ${project.collaborators}">
                <div>
                    <i class="bi bi-person-circle me-2 text-muted"></i>
                    <span th:text="${collab.nombre} + ' ' + ${collab.apellidos}"></span>
                </div>
                <span class="text-muted small" th:text="${collab.email}"></span>
            </div>
        </div>
        <p th:if="${#lists.isEmpty(project.collaborators)}" class="text-muted fst-italic">Aún no hay colaboradores asignados a este proyecto.</p>
    </div>

    <!-- Manager Invite Form (Hidden for Collaborator) -->
    <div class="mb-4" sec:authorize="hasAuthority('GESTOR')" th:if="${!project.closed}">
        <div class="card">
            <div class="card-body">
                <h4 class="h6">Invitar Colaborador</h4>
                <form th:action="@{/projects/{id}/invite(id=${project.id})}" method="post" class="row g-2 align-items-end">
                    <div class="col">
                        <label for="collaboratorEmail" class="form-label visually-hidden">Email Colaborador:</label>
                        <input type="email" id="collaboratorEmail" name="email" class="form-control form-control-sm" required placeholder="Email del colaborador...">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-secondary btn-sm"><i class="bi bi-person-plus me-1"></i> Invitar</button>
                    </div>
                    <div class="col-12">
                        <small class="form-text text-muted">Si el email ya existe como colaborador, se añadirá al proyecto. Si no existe, se creará un nuevo usuario colaborador.</small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <hr>

    <!-- Sección de Tareas -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5 mb-0"><i class="bi bi-check2-square me-2"></i> Tareas del Proyecto</h3>
        <a sec:authorize="hasAuthority('GESTOR')" th:if="${!project.closed}" th:href="@{/projects/{id}/tasks/new(id=${project.id})}" class="btn btn-success btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Nueva Tarea
        </a>
    </div>

    <div th:if="${#lists.isEmpty(tasks)}" class="alert alert-light text-center fst-italic" role="alert">
        No hay tareas creadas en este proyecto todavía.
    </div>

    <div class="table-responsive" th:unless="${#lists.isEmpty(tasks)}">
        <table class="table table-hover align-middle"> <!-- align-middle for vertical centering -->
            <thead class="table-light">
            <tr>
                <th>Título</th>
                <th>Asignada a</th>
                <th>Vencimiento</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="task : ${tasks}">
                <td>
                    <a th:href="@{/tasks/{taskId}(taskId=${task.id})}" th:text="${task.title}" class="fw-medium text-decoration-none">Título Tarea</a>
                </td>
                <td th:text="${task.assignedUser?.nombre} + ' ' + ${task.assignedUser?.apellidos ?: ''}">Usuario Asignado</td>
                <td th:text="${task.dueDate != null ? #temporals.format(task.dueDate, 'dd/MM/yyyy') : '-'}">Fecha</td>
                <td>
                <span th:switch="${task.status.name()}">
                  <span th:case="'PENDIENTE'" class="badge bg-warning text-dark" th:text="${task.status.displayName}"></span> <!-- Changed PENDIENTE color -->
                  <span th:case="'EN_PROGRESO'" class="badge bg-primary" th:text="${task.status.displayName}"></span>
                  <span th:case="'COMPLETADA'" class="badge bg-success" th:text="${task.status.displayName}"></span>
                  <span th:case="*" class="badge bg-secondary" th:text="${task.status}"></span> <!-- Generic fallback -->
                </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <!-- View/Comment accessible to involved Collaborator -->
                        <a th:if="${task.assignedUser?.email == #authentication.name}"
                           th:href="@{/tasks/{taskId}(taskId=${task.id})}" class="btn btn-outline-info" title="Ver Detalles y Comentarios"><i class="bi bi-chat-left-text"></i></a>

                        <!-- Mark as Accepted (Collaborator, only if PENDING and assigned) -->
                        <form sec:authorize="hasAuthority('COLABORADOR')"
                              th:if="${task.assignedUser?.email == #authentication.name and task.status.name() == 'PENDIENTE' and !project.closed}"
                              th:action="@{/tasks/{taskId}/accepted(taskId=${task.id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-outline-success" title="Marcar Tarea como Aceptada (En Progreso)">
                                <i class="bi bi-check2-circle"></i>
                            </button>
                        </form>

                        <!-- Edit/Delete (Manager only) -->
                        <a sec:authorize="hasAuthority('GESTOR')" th:if="${!project.closed}" th:href="@{/tasks/{taskId}/edit(taskId=${task.id})}" class="btn btn-outline-warning" title="Editar Tarea"><i class="bi bi-pencil"></i></a>
                        <form sec:authorize="hasAuthority('GESTOR')" th:if="${!project.closed}" th:action="@{/tasks/{taskId}/delete(taskId=${task.id})}" method="post" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar esta tarea?');">
                            <button type="submit" class="btn btn-outline-danger" title="Eliminar Tarea"><i class="bi bi-trash"></i></button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</section>
</body>
</html>